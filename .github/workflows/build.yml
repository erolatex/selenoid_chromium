name: Build and Push Docker Image

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check_chromium_and_build:
    runs-on: ubuntu-latest

    container:
      image: erolatex/selenoid_base_image:1.0.1

    steps:
      - name: Create last version file if not exists
        # Create an empty last_chromium_version.txt file if it does not exist
        run: |
          if [ ! -f last_chromium_version.txt ]; then
            touch last_chromium_version.txt
          fi

      - name: Set up the environment
        run: |
          apt-get update && apt-get install -y software-properties-common
          add-apt-repository -y ppa:xtradeb/apps
          apt-get update

      - name: Check Chromium Version
        run: |
          apt-cache madison chromium | grep xtradeb/apps | awk '{print $3}' > current_chromium_version.txt
          awk -F '.' '{print $1 "." $2}' current_chromium_version.txt > short_chromium_version.txt
        id: check_version

      - name: Compare versions
        run: |
          if [ -s last_chromium_version.txt ]; then
            diff last_chromium_version.txt current_chromium_version.txt || true;
          else
            echo "No previous version found, forcing Docker build.";
            exit 1;  # Force Docker build on first run or if file is empty
          fi
        id: version_check

      - name: Clone Dockerfile Repository
        if: failure() || steps.version_check.outcome == 'failure'
        uses: actions/checkout@v3
        with:
          repository: erolatex/images
          path: images

      - name: Set up Docker Buildx
        if: failure() || steps.version_check.outcome == 'failure'
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        if: failure() || steps.version_check.outcome == 'failure'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        if: failure() || steps.version_check.outcome == 'failure'
        run: |
          cd images/static/chromium
          docker buildx build --no-cache --build-arg BASE_IMAGE_TAG=1.0.1 \
            --platform linux/amd64,linux/arm64 \
            -t erolatex/selenoid_chromium:$(cat ../../../short_chromium_version.txt) \
            -t erolatex/selenoid_chromium:latest \
            --push .

      - name: Save current Chromium version
        if: failure() || steps.version_check.outcome == 'failure'
        run: |
          echo "Saving the current Chromium version."
          cp current_chromium_version.txt last_chromium_version.txt

      - name: Ensure last version file exists and is not empty
        # Check if the last version file exists and is not empty before caching
        run: |
          if [ -s last_chromium_version.txt ]; then
            echo "File last_chromium_version.txt exists and is not empty."
          else
            echo "File last_chromium_version.txt is missing or empty."
            exit 1;
          fi

      - name: Cache last version
        if: success()
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/last_chromium_version.txt
          key: chromium-version-cache
          restore-keys: |
            chromium-version-cache
